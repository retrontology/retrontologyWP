AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation Sample Template WordPress_Multi_AZ: WordPress is web
  software you can use to create a beautiful website or blog. This template
  installs a highly-available, scalable WordPress deployment using a multi-az
  Amazon RDS database instance for storage.
Parameters:
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  VpcCIDR:
    Description: Please enter the IP range (CIDR notation) for this VPC
    Type: String
    Default: 10.42.0.0/16
  PublicSubnet1CIDR:
    Description: >-
      Please enter the IP range (CIDR notation) for the public subnet in the
      first Availability Zone
    Type: String
    Default: 10.42.10.0/24
  PublicSubnet2CIDR:
    Description: >-
      Please enter the IP range (CIDR notation) for the public subnet in the
      second Availability Zone
    Type: String
    Default: 10.42.11.0/24
  PrivateSubnet1CIDR:
    Description: >-
      Please enter the IP range (CIDR notation) for the private subnet in the
      first Availability Zone
    Type: String
    Default: 10.42.20.0/24
  PrivateSubnet2CIDR:
    Description: >-
      Please enter the IP range (CIDR notation) for the private subnet in the
      second Availability Zone
    Type: String
    Default: 10.42.21.0/24
  DomainName:
    Description: The domain you want to use for the Wordpress site
    Type: String
    ConstraintDescription: must be a hosted zone in your account
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t4g.small
    AllowedValues:
      - t4g.nano
      - t4g.micro
      - t4g.small
      - t4g.medium
      - t4g.large
      - t4g.xlarge
      - t4g.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  BastionType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t4g.nano
    AllowedValues:
      - t4g.nano
      - t4g.micro
      - t4g.small
      - t4g.medium
      - t4g.large
      - t4g.xlarge
      - t4g.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  DBClass:
    Description: Database instance class
    Type: String
    Default: db.t2.micro
    AllowedValues:
      - db.t1.micro
      - db.m1.small
      - db.m1.medium
      - db.m1.large
      - db.m1.xlarge
      - db.m2.xlarge
      - db.m2.2xlarge
      - db.m2.4xlarge
      - db.m3.medium
      - db.m3.large
      - db.m3.xlarge
      - db.m3.2xlarge
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.r3.large
      - db.r3.xlarge
      - db.r3.2xlarge
      - db.r3.4xlarge
      - db.r3.8xlarge
      - db.m2.xlarge
      - db.m2.2xlarge
      - db.m2.4xlarge
      - db.t2.micro
      - db.t2.small
      - db.t2.medium
      - db.t2.large
    ConstraintDescription: must select a valid database instance type.
  DBName:
    Default: wordpressdb
    Description: The WordPress database name
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBUser:
    NoEcho: 'true'
    Description: The WordPress database admin account username
    Type: String
    MinLength: '1'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: 'true'
    Description: The WordPress database admin account password
    Type: String
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
  MultiAZDatabase:
    Default: 'false'
    Description: Create a Multi-AZ MySQL Amazon RDS database instance
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    ConstraintDescription: must be either true or false.
  MultiAZElastiCache:
    Default: single-az
    Description: Create a Multi-AZ MySQL Amazon ElastiCache cluster instance
    Type: String
    AllowedValues:
      - cross-az
      - single-az
    ConstraintDescription: must be either 'single-az' or 'cross-az'
  ECClass:
    Description: ElastiCache instance class
    Type: String
    Default: cache.t4g.small
    AllowedValues:
      - cache.m6g.large
      - cache.m6g.xlarge
      - cache.m6g.2xlarge
      - cache.m6g.4xlarge
      - cache.m6g.8xlarge
      - cache.m6g.12xlarge
      - cache.m6g.16xlarge
      - cache.m5.large
      - cache.m5.xlarge
      - cache.m5.2xlarge
      - cache.m5.4xlarge
      - cache.m5.12xlarge
      - cache.m5.24xlarge
      - cache.m4.large
      - cache.m4.xlarge
      - cache.m4.2xlarge
      - cache.m4.4xlarge
      - cache.m4.10xlarge
      - cache.t4g.micro
      - cache.t4g.small
      - cache.t4g.medium
      - cache.t3.small
      - cache.t3.medium
      - cache.t2.micro
      - cache.t2.small
      - cache.t2.medium
  ECNumNodes:
    Default: '1'
    Description: The number of nodes in your ElastiCache cluster
    Type: Number
    MinValue: '1'
    MaxValue: '5'
    ConstraintDescription: must be between 1 and 5 cache instances.
  WebServerCapacity:
    Default: '1'
    Description: The initial number of WebServer instances
    Type: Number
    MinValue: '1'
    MaxValue: '5'
    ConstraintDescription: must be between 1 and 5 EC2 instances.
  DBAllocatedStorage:
    Default: '5'
    Description: The size of the database (Gb)
    Type: Number
    MinValue: '5'
    MaxValue: '1024'
    ConstraintDescription: must be between 5 and 1024Gb.
Mappings:
  AWSInstanceType2Arch:
    t4g.nano:
      Arch: ARM64
    t4g.micro:
      Arch: ARM64
    t4g.small:
      Arch: ARM64
    t4g.medium:
      Arch: ARM64
    t4g.large:
      Arch: ARM64
    t4g.xlarge:
      Arch: ARM64
    t4g.2xlarge:
      Arch: ARM64
  AWSRegionArch2AMI:
    af-south-1:
      HVM64: ami-064cc455f8a1ef504
      HVMG2: NOT_SUPPORTED
    ap-east-1:
      HVM64: ami-f85b1989
      HVMG2: NOT_SUPPORTED
    ap-northeast-1:
      HVM64: ami-0b2c2a754d5b4da22
      HVMG2: ami-09d0e0e099ecabba2
    ap-northeast-2:
      HVM64: ami-0493ab99920f410fc
      HVMG2: NOT_SUPPORTED
    ap-northeast-3:
      HVM64: ami-01344f6f63a4decc1
      HVMG2: NOT_SUPPORTED
    ap-south-1:
      HVM64: ami-03cfb5e1fb4fac428
      HVMG2: ami-0244c1d42815af84a
    ap-southeast-1:
      HVM64: ami-0ba35dc9caf73d1c7
      HVMG2: ami-0e46ce0d6a87dc979
    ap-southeast-2:
      HVM64: ami-0ae99b503e8694028
      HVMG2: ami-0c0ab057a101d8ff2
    ca-central-1:
      HVM64: ami-0803e21a2ec22f953
      HVMG2: NOT_SUPPORTED
    cn-north-1:
      HVM64: ami-07a3f215cc90c889c
      HVMG2: NOT_SUPPORTED
    cn-northwest-1:
      HVM64: ami-0a3b3b10f714a0ff4
      HVMG2: NOT_SUPPORTED
    eu-central-1:
      HVM64: ami-0474863011a7d1541
      HVMG2: ami-0aa1822e3eb913a11
    eu-north-1:
      HVM64: ami-0de4b8910494dba0f
      HVMG2: ami-32d55b4c
    eu-south-1:
      HVM64: ami-08427144fe9ebdef6
      HVMG2: NOT_SUPPORTED
    eu-west-1:
      HVM64: ami-015232c01a82b847b
      HVMG2: ami-0d5299b1c6112c3c7
    eu-west-2:
      HVM64: ami-0765d48d7e15beb93
      HVMG2: NOT_SUPPORTED
    eu-west-3:
      HVM64: ami-0caf07637eda19d9c
      HVMG2: NOT_SUPPORTED
    me-south-1:
      HVM64: ami-0744743d80915b497
      HVMG2: NOT_SUPPORTED
    sa-east-1:
      HVM64: ami-0a52e8a6018e92bb0
      HVMG2: NOT_SUPPORTED
    us-east-1:
      HVM64: ami-032930428bf1abbff
      HVMG2: ami-0aeb704d503081ea6
    us-east-2:
      ARM64: ami-0f822d3c9e0532335
      HVM64: ami-027cab9a7bf0155df
      HVMG2: NOT_SUPPORTED
    us-west-1:
      HVM64: ami-088c153f74339f34c
      HVMG2: ami-0a7fc72dc0e51aa77
    us-west-2:
      HVM64: ami-01fee56b22f308154
      HVMG2: ami-0fe84a5b4563d8f27
Resources:
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Ref 'AWS::StackId'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'AWS::StackId'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b14eae7a-33d2-4863-b903-b2b52de4fb8b
  InternetGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 138c0655-6f0e-409f-8905-68f063607271
  PublicSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select 
        - 0
        - !GetAZs ''
      CidrBlock: !Ref PublicSubnet1CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Public Subnet (AZ1)'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select 
        - 1
        - !GetAZs ''
      CidrBlock: !Ref PublicSubnet2CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Public Subnet (AZ2)'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 59defcc5-0aa0-422b-92a9-6918a8a982fb
  PrivateSubnet1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select 
        - 0
        - !GetAZs ''
      CidrBlock: !Ref PrivateSubnet1CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Private Subnet (AZ1)'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e5ac4178-e12e-4bc6-bfcf-c17932ed891c
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select 
        - 1
        - !GetAZs ''
      CidrBlock: !Ref PrivateSubnet2CIDR
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Private Subnet (AZ2)'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 1ee955f9-a706-4bcd-a6e5-aa7682786822
  NatGateway1EIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3b10dc31-0923-4db1-96de-9e6db4c26eb0
  NatGateway1:
    Type: 'AWS::EC2::NatGateway'
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 809aad88-72eb-4a7a-b9ce-1f55e44e5f06
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Public Routes'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f8bc1ef4-8f64-4911-a06f-22ff761c0370
  DefaultPublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 7a0fd9f2-7511-4298-9d3d-37ae8db2b673
  PublicSubnet1RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1
  PublicSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2
  PrivateRouteTable1:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackId} Private Routes (AZ1)'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d9499d33-286d-492c-9881-976932f380be
  DefaultPrivateRoute1:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d44e3916-e942-4965-a488-21a2a96e0f1a
  PrivateSubnet1RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1
  PrivateSubnet2RouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet2
  HostedZone:
    Type: 'AWS::Route53::HostedZone'
    Properties:
      Name: !Ref DomainName
    Metadata:
      'AWS::CloudFormation::Designer':
        id: bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
  DNSBaseRecord:
    Type: 'AWS::Route53::RecordSet'
    Properties:
      AliasTarget:
        HostedZoneId: !GetAtt 
          - ApplicationLoadBalancer
          - CanonicalHostedZoneID
        DNSName: !GetAtt 
          - ApplicationLoadBalancer
          - DNSName
      HostedZoneId: !Ref HostedZone
      Name: !Join 
        - ''
        - - !Ref DomainName
          - .
      Type: A
      Comment: Base domain for Wordpress
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2af4ee94-6788-415c-b84b-3718f8e03d3d
  DNSWWWRecord:
    Type: 'AWS::Route53::RecordSet'
    Properties:
      AliasTarget:
        HostedZoneId: !GetAtt 
          - ApplicationLoadBalancer
          - CanonicalHostedZoneID
        DNSName: !GetAtt 
          - ApplicationLoadBalancer
          - DNSName
      HostedZoneId: !Ref HostedZone
      Name: !Join 
        - ''
        - - www.
          - !Ref DomainName
          - .
      Type: A
      Comment: www domain for Wordpress
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 1489d6ef-a335-449b-9286-b36f365b1fd9
  DNSBastionRecord:
    Type: 'AWS::Route53::RecordSet'
    Properties:
      HostedZoneId: !Ref HostedZone
      Name: !Join 
        - ''
        - - bastion.
          - !Ref DomainName
          - .
      Type: A
      TTL: 300
      Comment: bastion domain for SSH access
      ResourceRecords:
        - !Ref BastionEIP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d84ed842-c1cb-4459-87f2-e005e58fa21c
  CertificateBase:
    Type: 'AWS::CertificateManager::Certificate'
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Join 
          - ''
          - - www.
            - !Ref DomainName
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZone
      ValidationMethod: DNS
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 345fc7cd-b48e-4505-9eb2-002e6ecfb7b5
    DependsOn:
      - DNSBaseRecord
  BastionEIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
      InstanceId: !Ref BastionInstance
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4d7944ca-ecd8-4084-82cc-511abf763c82
  BastionEC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Open Bastion for access publicly via ssh
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: !Ref SSHLocation
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 205bc594-8b09-48a5-a4ca-2b127d5971dd
  KeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyFormat: pem
      KeyName: wordpress-keypair
      KeyType: ed25519
  BastionInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyPair
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref BastionType
      SecurityGroupIds:
        - !Ref BastionEC2SecurityGroup
      SubnetId: !Ref PublicSubnet1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 8115054e-8d32-459c-a1ca-bf6204ba9291
  ALBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable HTTP access via port 443 from anywhere
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 414a33b1-fd1d-4a02-b3ec-b437c00c9a65
  ApplicationLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 43c68a68-362e-4bb2-809c-ddb42e7c48dc
  ALBHTTPSListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: '443'
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateBase
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 14b97c56-0c9c-45b5-851b-b52d968acb47
  ALBHTTPListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: '80'
      Protocol: HTTP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 10c646bf-a833-4785-a98c-d45c0db35077
  ALBTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckPath: /wp-admin/install.php
      HealthCheckIntervalSeconds: 10
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 5
      VpcId: !Ref VPC
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'true'
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: '30'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f0ac89f8-9931-4cd3-9337-19983150aea6
  WebServerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        Enable HTTP access via port 80 locked down to the load balancer + SSH
        access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          SourceSecurityGroupId: !Ref BastionEC2SecurityGroup
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 362849ae-7204-48e6-991d-cbaf04806159
  WebServerComponentEFS:
    Type: AWS::ImageBuilder::Component
    Properties:
      Data: |
        name: WebServerComponentEFS - InlineData
        description: Image Component for Wordpress CF stack designed to install and configure EFS
        schemaVersion: 1.0
        parameters:
          - EFSID:
              type: string
              description: The ID of the EFS volume
        phases:
          - name: build
            steps:
              - name: InstallDeps
                action: ExecuteBash
                inputs:
                  commands:
                    - sudo yum update -y
                    - sudo yum install -y nfs-utils
              - name: CreateEFSDir
                action: CreateFolder
                inputs:
                  - path: /mnt/efs
              - name: MountEFS
                action: ExecuteBash
                inputs:
                  commands:
                    - sudo su -c "echo '{{ EFSID }}:/ /mnt/efs efs _netdev,noresvport,tls,iam 0 0' >> /etc/fstab"
                    - sudo mount -a
              - name: CreateWordpressDir
                action: CreateFolder
                inputs:
                  - path: /mnt/efs/wp-content
                    overwrite: false
              - name: CreateHTMLDir
                action: CreateFolder
                inputs:
                  - path: /var/www/html
              - name: SoftlinkWordpressDir
                action: CreateSymlink
                inputs:
                  - path: /mnt/efs/wp-content
                    target: /var/www/html/wp-content
                    force: true

      Description: Image Component for Wordpress CF stack designed to install and configure EFS
      Name: WebServerComponentEFS
      Platform: Linux
      SupportedOsVersions: 
        - 'Amazon Linux 2'
      Version: 1.0.0
  WebServerComponentPHP:
    Type: AWS::ImageBuilder::Component
    Properties:
      Data: |
        name: WebServerComponentPHP - InlineData
        description: Image Component for Wordpress CF stack designed to install and configure PHP
        schemaVersion: 1.0
        phases:
          - name: build
            steps:
              - name: InstallDeps
                action: ExecuteBash
                inputs:
                  commands:
                    - sudo yum update -y
                    - sudo yum install -y amazon-linux-extras 
                    - sudo amazon-linux-extras enable php8.1
                    - sudo yum install -y gcc php php-devel php-mysqlnd php-pear php-gd php-mbstring php-intl ImageMagick ImageMagick-devel libmemcached-devel openssl11-devel
                    - sudo pear channel-update pear.php.net
                    - sudo pecl channel-update pecl.php.net
                    - sudo pecl install imagick
              - name: EnableImagick
                action: CreateFile
                inputs:
                  - path: /etc/php.d/20-imagick.ini
                    content: extension=imagick.so
                    overwrite: false
      Description: Image Component for Wordpress CF stack designed to install and configure PHP
      Name: WebServerComponentPHP
      Platform: Linux
      SupportedOsVersions: 
        - 'Amazon Linux 2'
      Version: 1.0.0
  WebServerComponentEC:
    Type: AWS::ImageBuilder::Component
    Properties:
      Data: |
        name: WebServerComponentEC - InlineData
        description: Image Component for Wordpress CF stack designed to install and configure ElastiCache
        schemaVersion: 1.0
        phases:
          - name: build
            steps:
              - name: InstallDeps
                action: ExecuteBash
                inputs:
                  commands:
                    - sudo yum update -y
                    - sudo yum install -y git gcc gcc-c++ autoconf libevent-devel make perl-core pcre-devel wget zlib-devel 
              - name: InstallLibmemcached
                action: ExecuteBash
                inputs:
                  commands:
                    - cd /tmp
                    - git clone https://github.com/awslabs/aws-elasticache-cluster-client-libmemcached libmemcached
                    - cd elasticache/libmemcached
                    - touch configure.ac aclocal.m4 configure Makefile.am Makefile.in
                    - mkdir build && cd build
                    - ../configure --with-pic --disable-sasl
                    - make -j$(nproc)
                    - sudo make install
              - name: InstallMemcachedPHP
                action: ExecuteBash
                inputs:
                  commands:
                    - cd /tmp
                    - git clone https://github.com/awslabs/aws-elasticache-cluster-client-memcached-for-php.git memcachedphp
                    - cd memcachedphp
                    - phpize
                    - cd build
                    - ../configure --disable-memcached-sasl
                    - make -j$(nproc)
                    - sudo make install
              - name: EnableMemcachedPHP
                action: CreateFile
                inputs:
                  - path: /etc/php.d/20-memcached.ini
                    content: extension=memcached.so
                    overwrite: false
      Description: Image Component for Wordpress CF stack designed to install and configure ElastiCache
      Name: WebServerComponentEC
      Platform: Linux
      SupportedOsVersions: 
        - 'Amazon Linux 2'
      Version: 1.0.0
  WebServerComponentWordpress:
    Type: AWS::ImageBuilder::Component
    Properties:
      Data: |
        name: WebServerComponentWordpress - InlineData
        description: Image Component for Wordpress CF stack designed to install and configure ElastiCache
        schemaVersion: 1.0
        parameters:
          - DBName:
              type: string
              description: The name of the DB schema to use for Wordpress
          - DBUser:
              type: string
              description: The Wordpress DB user name
          - DBPassword:
              type: string
              description: The password for the Wordpress DB user
          - DBEndpoint:
              type: string
              description: The endpoint of the RDS writer instance
        phases:
          - name: build
            steps:
              - name: InstallDeps
                action: ExecuteBash
                inputs:
                  commands:
                    - sudo yum update -y
                    - sudo yum install -y mariadb httpd
              - name: DownloadWordpress
                action: WebDownload
                inputs:
                  - source: https://wordpress.org/latest.tar.gz
                    destination: /tmp/wordpress.tar.gz
                    overwrite: true
              - name: ConfigureWordpress
                action: ExecuteBash
                inputs:
                  commands:
                    - cd /tmp
                    - tar -xzvf wordpress.tar.gz
                    - cp /tmp/wordpress/wp-config-sample.php /tmp/wordpress/wp-config.php
                    - sed -i "s/'database_name_here'/'{{ DBName }}'/g" /tmp/wordpress/wp-config.php
                    - sed -i "s/'username_here'/'{{ DBUser }}'/g" /tmp/wordpress/wp-config.php
                    - sed -i "s/'password_here'/'{{ DBPassword }}'/g" /tmp/wordpress/wp-config.php
                    - sed -i "s/'localhost'/'{{ DBEndpoint }}'/g" /tmp/wordpress/wp-config.php
                    - sed -i "/\/\* Add any custom values between this line and the \"stop editing\" line. \*\//a \ \ \ \ \$_SERVER['HTTPS']='on';" /tmp/wordpress/wp-config.php
                    - sed -i "/\/\* Add any custom values between this line and the \"stop editing\" line. \*\//a if (strpos(\$_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false)" /tmp/wordpress/wp-config.php
                    - sed -i "/\/\* Add any custom values between this line and the \"stop editing\" line. \*\//a  define('FORCE_SSL_ADMIN', true);" /tmp/wordpress/wp-config.php
                    - sed -i "/\/\* Add any custom values between this line and the \"stop editing\" line. \*\//a define('FS_METHOD', 'direct');" /tmp/wordpress/wp-config.php
              - name: InstallWordpress
                action: ExecuteBash
                inputs:
                  commands:
                    - mv /tmp/wordpress/wp-content/* /mnt/efs/wp-content/
                    - rm -r /tmp/wordpress/wp-content
                    - mv /tmp/wordpress/* /var/www/html/
                    - touch /var/www/html/.htaccess
                    - rm -r /tmp/wordpress
                    - chown -R apache:apache /mnt/efs/wp-content /var/www/html/
      Description: Image Component for Wordpress CF stack designed to install and configure Wordpress
      Name: WebServerComponentWordpress
      Platform: Linux
      SupportedOsVersions: 
        - 'Amazon Linux 2'
      Version: 1.0.0
  WebServerImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Components: 
        - ComponentArn: !Ref WebServerComponentEFS
          Parameters: 
            - Name: EFSID
              Value: 
                - !Ref ElasticFileSystem
        - ComponentArn: !Ref WebServerComponentPHP
        - ComponentArn: !Ref WebServerComponentEC
        - ComponentArn: !Ref WebServerComponentWordpress
          Parameters:
            - Name: DBName
              Value: 
                - !Ref DBName
            - Name: DBUser
              Value: 
                - !Ref DBUser
            - Name: DBPassword
              Value: 
                - !Ref DBPassword
            - Name: DBEndpoint
              Value: 
                - !GetAtt 
                    - DBInstance
                    - Endpoint.Address
      Description: Image Recipe designed to cut down on instance spin up time in Wordpress web server autoscaling group
      Name: wordpressImage
      ParentImage: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      Version: 1.0.0
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "ec2.amazonaws.com"
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/EC2InstanceProfileForImageBuilder
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole
  WebServerImageInfraConfig:
    Type: AWS::ImageBuilder::InfrastructureConfiguration
    Properties:
      Description: Infrastructure Configuration for building the Wordpress web server instance image
      InstanceProfileName: !Ref InstanceProfile
      InstanceTypes: 
        - !Ref InstanceType
      KeyPair: !Ref KeyPair
      Name: WordpressInfraConfig
      SecurityGroupIds: 
        - !Ref WebServerSecurityGroup
      SubnetId: !Ref PrivateSubnet2
      TerminateInstanceOnFailure: true
  WebServerImage:
    Type: AWS::ImageBuilder::Image
    Properties:
      ImageRecipeArn: !Ref WebServerImageRecipe
      InfrastructureConfigurationArn: !Ref WebServerImageInfraConfig
      Tags: 
        Name: WordpressImage
  WebServerGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      LaunchConfigurationName: !Ref LaunchConfig
      MinSize: '1'
      MaxSize: '5'
      DesiredCapacity: !Ref WebServerCapacity
      TargetGroupARNs:
        - !Ref ALBTargetGroup
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: '1'
        MaxBatchSize: '1'
        PauseTime: PT15M
        WaitOnResourceSignals: 'true'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 747b90ec-c810-4b21-9903-b02f5eb329f1
  LaunchConfig:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2db1c3d7-c460-4fca-b705-2d9cc49e6544
    Properties:
      ImageId: !Ref WebServerImage
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyPair
  DBEC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Open database for access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          SourceSecurityGroupId: !Ref BastionEC2SecurityGroup
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9d93aad7-4e7a-4bed-bf97-d1fdf6b10d9d
  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: Subnet for database
      DBSubnetGroupName: DBSubnetGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 7c44c759-f180-41d9-900e-6ff3b8689749
  DBInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBName: !Ref DBName
      Engine: MySQL
      MultiAZ: !Ref MultiAZDatabase
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      DBInstanceClass: !Ref DBClass
      AllocatedStorage: !Ref DBAllocatedStorage
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 3
      DeleteAutomatedBackups: false
      VPCSecurityGroups:
        - !GetAtt 
          - DBEC2SecurityGroup
          - GroupId
    Metadata:
      'AWS::CloudFormation::Designer':
        id: de78acbe-b0b8-44df-bda2-8aafa58ccce9
  ElasticFileSystem:
    Type: 'AWS::EFS::FileSystem'
    Properties:
      BackupPolicy:
        Status: ENABLED
      Encrypted: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a04d49ae-7344-4df0-b1fa-b68039ae9f56
  EFSMountPoint1:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      FileSystemId: !Ref ElasticFileSystem
      SecurityGroups:
        - !Ref EFSSecurityGroup
      SubnetId: !Ref PrivateSubnet1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2d8cc840-fe1b-43ca-aae6-fc96df6dead8
  EFSMountPoint2:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      FileSystemId: !Ref ElasticFileSystem
      SecurityGroups:
        - !Ref EFSSecurityGroup
      SubnetId: !Ref PrivateSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 7f32758e-8b9e-4958-af93-ddf4b66fd99a
  EFSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Open EFS for access internally to app servers
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref BastionEC2SecurityGroup
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 1acf09b2-6e48-4999-86f9-e3d3510ddaed
  ECSubnetGroup:
    Type: 'AWS::ElastiCache::SubnetGroup'
    Properties:
      Description: Subnet Group for ElastiCache cluster
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4075728a-3101-4a4c-9aad-46e05c502a94
  ElastiCacheInstance:
    Type: 'AWS::ElastiCache::CacheCluster'
    Properties:
      AZMode: !Ref MultiAZElastiCache
      CacheNodeType: !Ref ECClass
      CacheSubnetGroupName: !Ref ECSubnetGroup
      Engine: memcached
      NumCacheNodes: !Ref ECNumNodes
      VpcSecurityGroupIds:
        - !Ref ECEC2SecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 35400c6f-f5a3-4a02-8dd1-45481222602f
  ECEC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Open CC for access internally to app servers
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 11211
          ToPort: 11211
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
        - IpProtocol: tcp
          FromPort: 11211
          ToPort: 11211
          SourceSecurityGroupId: !Ref BastionEC2SecurityGroup
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 686281a3-ada2-4a10-af72-f0287cce5d73
Outputs:
  WebsiteURL:
    Description: The address to use for the CNAME value of the DNS entry
    Value: !Join 
      - .
      - - 'https://www'
        - !Ref DomainName
  MemcacheURL:
    Description: The URL string to use for memcached in whichever plugin you choose
    Value: !Join 
      - ':'
      - - !GetAtt 
          - ElastiCacheInstance
          - ConfigurationEndpoint.Address
        - !GetAtt 
          - ElastiCacheInstance
          - ConfigurationEndpoint.Port
Metadata:
  'AWS::CloudFormation::Designer':
    7c44c759-f180-41d9-900e-6ff3b8689749:
      size:
        width: 80
        height: 280
      position:
        x: 2470
        'y': 600
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - de78acbe-b0b8-44df-bda2-8aafa58ccce9
    f0ac89f8-9931-4cd3-9337-19983150aea6:
      size:
        width: 60
        height: 60
      position:
        x: 2080
        'y': 710
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
    43c68a68-362e-4bb2-809c-ddb42e7c48dc:
      size:
        width: 60
        height: 60
      position:
        x: 1880
        'y': 710
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      isassociatedwith:
        - 414a33b1-fd1d-4a02-b3ec-b437c00c9a65
      iscontainedinside:
        - c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
        - 59defcc5-0aa0-422b-92a9-6918a8a982fb
    362849ae-7204-48e6-991d-cbaf04806159:
      size:
        width: 60
        height: 60
      position:
        x: 2280
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    9d93aad7-4e7a-4bed-bf97-d1fdf6b10d9d:
      size:
        width: 60
        height: 60
      position:
        x: 2480
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    de78acbe-b0b8-44df-bda2-8aafa58ccce9:
      size:
        width: 60
        height: 60
      position:
        x: 2480
        'y': 710
      z: 3
      parent: 7c44c759-f180-41d9-900e-6ff3b8689749
      embeds: []
    2db1c3d7-c460-4fca-b705-2d9cc49e6544:
      size:
        width: 60
        height: 60
      position:
        x: 2280
        'y': 710
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
    747b90ec-c810-4b21-9903-b02f5eb329f1:
      size:
        width: 60
        height: 60
      position:
        x: 2180
        'y': 710
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      isassociatedwith:
        - 2db1c3d7-c460-4fca-b705-2d9cc49e6544
        - f0ac89f8-9931-4cd3-9337-19983150aea6
      iscontainedinside:
        - e5ac4178-e12e-4bc6-bfcf-c17932ed891c
        - 1ee955f9-a706-4bcd-a6e5-aa7682786822
    14b97c56-0c9c-45b5-851b-b52d968acb47:
      size:
        width: 60
        height: 60
      position:
        x: 1980
        'y': 760
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
    414a33b1-fd1d-4a02-b3ec-b437c00c9a65:
      size:
        width: 60
        height: 60
      position:
        x: 1880
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    10c646bf-a833-4785-a98c-d45c0db35077:
      size:
        width: 60
        height: 60
      position:
        x: 1980
        'y': 650
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
    a04d49ae-7344-4df0-b1fa-b68039ae9f56:
      size:
        width: 60
        height: 60
      position:
        x: 2570
        'y': 710
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
    7f32758e-8b9e-4958-af93-ddf4b66fd99a:
      size:
        width: 60
        height: 60
      position:
        x: 2570
        'y': 810
      z: 3
      parent: 1ee955f9-a706-4bcd-a6e5-aa7682786822
      embeds: []
    2d8cc840-fe1b-43ca-aae6-fc96df6dead8:
      size:
        width: 60
        height: 60
      position:
        x: 2570
        'y': 610
      z: 3
      parent: e5ac4178-e12e-4bc6-bfcf-c17932ed891c
      embeds: []
    1acf09b2-6e48-4999-86f9-e3d3510ddaed:
      size:
        width: 60
        height: 60
      position:
        x: 2570
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    4075728a-3101-4a4c-9aad-46e05c502a94:
      size:
        width: 80
        height: 280
      position:
        x: 2370
        'y': 600
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 35400c6f-f5a3-4a02-8dd1-45481222602f
    35400c6f-f5a3-4a02-8dd1-45481222602f:
      size:
        width: 60
        height: 60
      position:
        x: 2380
        'y': 710
      z: 3
      parent: 4075728a-3101-4a4c-9aad-46e05c502a94
      embeds: []
      isassociatedwith:
        - 686281a3-ada2-4a10-af72-f0287cce5d73
      iscontainedinside:
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 4075728a-3101-4a4c-9aad-46e05c502a94
    686281a3-ada2-4a10-af72-f0287cce5d73:
      size:
        width: 60
        height: 60
      position:
        x: 2380
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    345fc7cd-b48e-4505-9eb2-002e6ecfb7b5:
      size:
        width: 60
        height: 60
      position:
        x: 1290
        'y': 710
      z: 3
      parent: bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
      embeds: []
      dependson:
        - 2af4ee94-6788-415c-b84b-3718f8e03d3d
    2af4ee94-6788-415c-b84b-3718f8e03d3d:
      size:
        width: 60
        height: 60
      position:
        x: 1390
        'y': 710
      z: 3
      parent: bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
      embeds: []
    1489d6ef-a335-449b-9286-b36f365b1fd9:
      size:
        width: 60
        height: 60
      position:
        x: 1390
        'y': 800
      z: 3
      parent: bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
      embeds: []
    bb790a58-d9bc-4043-b0ca-c0fee5bd1c46:
      size:
        width: 200
        height: 280
      position:
        x: 1270
        'y': 600
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 1489d6ef-a335-449b-9286-b36f365b1fd9
        - 2af4ee94-6788-415c-b84b-3718f8e03d3d
        - 345fc7cd-b48e-4505-9eb2-002e6ecfb7b5
        - d84ed842-c1cb-4459-87f2-e005e58fa21c
    b14eae7a-33d2-4863-b903-b2b52de4fb8b:
      size:
        width: 60
        height: 60
      position:
        x: 950
        'y': 670
      z: 0
      embeds: []
    3278cfa4-acbf-4d99-b8d8-982f9a8960ee:
      size:
        width: 1610
        height: 510
      position:
        x: 1060
        'y': 460
      z: 1
      embeds:
        - a04d49ae-7344-4df0-b1fa-b68039ae9f56
        - bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
        - f0ac89f8-9931-4cd3-9337-19983150aea6
        - 414a33b1-fd1d-4a02-b3ec-b437c00c9a65
        - 205bc594-8b09-48a5-a4ca-2b127d5971dd
        - 362849ae-7204-48e6-991d-cbaf04806159
        - 686281a3-ada2-4a10-af72-f0287cce5d73
        - 1acf09b2-6e48-4999-86f9-e3d3510ddaed
        - 9d93aad7-4e7a-4bed-bf97-d1fdf6b10d9d
        - 2db1c3d7-c460-4fca-b705-2d9cc49e6544
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - 1ee955f9-a706-4bcd-a6e5-aa7682786822
        - e5ac4178-e12e-4bc6-bfcf-c17932ed891c
        - 4075728a-3101-4a4c-9aad-46e05c502a94
        - 7c44c759-f180-41d9-900e-6ff3b8689749
        - 747b90ec-c810-4b21-9903-b02f5eb329f1
        - 59defcc5-0aa0-422b-92a9-6918a8a982fb
        - c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
        - 43c68a68-362e-4bb2-809c-ddb42e7c48dc
        - 10c646bf-a833-4785-a98c-d45c0db35077
        - 14b97c56-0c9c-45b5-851b-b52d968acb47
        - 4d7944ca-ecd8-4084-82cc-511abf763c82
    d9499d33-286d-492c-9881-976932f380be:
      size:
        width: 100
        height: 90
      position:
        x: 1760
        'y': 790
      z: 3
      parent: c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
      embeds:
        - d44e3916-e942-4965-a488-21a2a96e0f1a
    f8bc1ef4-8f64-4911-a06f-22ff761c0370:
      size:
        width: 100
        height: 110
      position:
        x: 1150
        'y': 630
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 7a0fd9f2-7511-4298-9d3d-37ae8db2b673
    1ee955f9-a706-4bcd-a6e5-aa7682786822:
      size:
        width: 590
        height: 120
      position:
        x: 2060
        'y': 790
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 7f32758e-8b9e-4958-af93-ddf4b66fd99a
    e5ac4178-e12e-4bc6-bfcf-c17932ed891c:
      size:
        width: 580
        height: 110
      position:
        x: 2060
        'y': 580
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 2d8cc840-fe1b-43ca-aae6-fc96df6dead8
    59defcc5-0aa0-422b-92a9-6918a8a982fb:
      size:
        width: 460
        height: 110
      position:
        x: 1490
        'y': 590
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 8115054e-8d32-459c-a1ca-bf6204ba9291
    c0c4b0fc-bbec-45a9-82e2-f6eb5957b022:
      size:
        width: 380
        height: 110
      position:
        x: 1570
        'y': 780
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds:
        - 3b10dc31-0923-4db1-96de-9e6db4c26eb0
        - d9499d33-286d-492c-9881-976932f380be
        - 809aad88-72eb-4a7a-b9ce-1f55e44e5f06
    7a0fd9f2-7511-4298-9d3d-37ae8db2b673:
      size:
        width: 60
        height: 60
      position:
        x: 1170
        'y': 660
      z: 3
      parent: f8bc1ef4-8f64-4911-a06f-22ff761c0370
      embeds: []
      isassociatedwith:
        - b14eae7a-33d2-4863-b903-b2b52de4fb8b
      iscontainedinside:
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
        - f8bc1ef4-8f64-4911-a06f-22ff761c0370
    3b10dc31-0923-4db1-96de-9e6db4c26eb0:
      size:
        width: 60
        height: 60
      position:
        x: 1580
        'y': 810
      z: 3
      parent: c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
      embeds: []
    809aad88-72eb-4a7a-b9ce-1f55e44e5f06:
      size:
        width: 60
        height: 60
      position:
        x: 1680
        'y': 810
      z: 3
      parent: c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
      embeds: []
    d44e3916-e942-4965-a488-21a2a96e0f1a:
      size:
        width: 60
        height: 60
      position:
        x: 1780
        'y': 810
      z: 4
      parent: d9499d33-286d-492c-9881-976932f380be
      embeds: []
      isassociatedwith:
        - 809aad88-72eb-4a7a-b9ce-1f55e44e5f06
      iscontainedinside:
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
        - d9499d33-286d-492c-9881-976932f380be
    8115054e-8d32-459c-a1ca-bf6204ba9291:
      size:
        width: 60
        height: 60
      position:
        x: 1790
        'y': 620
      z: 3
      parent: 59defcc5-0aa0-422b-92a9-6918a8a982fb
      embeds: []
      isassociatedwith:
        - 205bc594-8b09-48a5-a4ca-2b127d5971dd
      iscontainedinside:
        - 59defcc5-0aa0-422b-92a9-6918a8a982fb
        - 59defcc5-0aa0-422b-92a9-6918a8a982fb
        - 59defcc5-0aa0-422b-92a9-6918a8a982fb
        - c0c4b0fc-bbec-45a9-82e2-f6eb5957b022
    205bc594-8b09-48a5-a4ca-2b127d5971dd:
      size:
        width: 60
        height: 60
      position:
        x: 1790
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      iscontainedinside:
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
        - 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
    d84ed842-c1cb-4459-87f2-e005e58fa21c:
      size:
        width: 60
        height: 60
      position:
        x: 1390
        'y': 620
      z: 3
      parent: bb790a58-d9bc-4043-b0ca-c0fee5bd1c46
      embeds: []
    4d7944ca-ecd8-4084-82cc-511abf763c82:
      size:
        width: 60
        height: 60
      position:
        x: 1390
        'y': 500
      z: 2
      parent: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      embeds: []
      isassociatedwith:
        - 8115054e-8d32-459c-a1ca-bf6204ba9291
    138c0655-6f0e-409f-8905-68f063607271:
      source:
        id: 3278cfa4-acbf-4d99-b8d8-982f9a8960ee
      target:
        id: b14eae7a-33d2-4863-b903-b2b52de4fb8b
      z: 1
